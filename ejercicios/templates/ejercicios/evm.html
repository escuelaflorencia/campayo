{% extends 'ejercicios_base.html' %}

{% block title %}{{ ejercicio.codigo }} - Entrenamiento de Velocidad de Memorización - Campayo{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para EVM */
    .evm-display-area {
        
        border-radius: 12px;
        min-height: 350px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        margin: 1rem 0;
    }

    .evm-content {
        text-align: center;
        transition: all 0.4s ease;
        width: 100%;
        padding: 2rem;
    }

    /* Lista de items */
    .evm-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        max-width: 400px;
        margin: 0 auto;
    }

    .evm-item {
        background: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--campayo-primary);
        min-width: 200px;
        transition: all 0.3s ease;
        border-left: 4px solid var(--campayo-primary);
    }

    .evm-item.highlight {
        background: var(--campayo-primary);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(13, 110, 253, 0.3);
    }

    /* Fase de memorización */
    .memorization-phase {
        text-align: center;
    }

    .memorization-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--campayo-primary);
        margin-bottom: 2rem;
    }

    .countdown-display {
        font-size: 4rem;
        font-weight: bold;
        color: var(--campayo-warning);
        margin: 2rem 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    /* Fase de recuerdo */
    .recall-phase {
        text-align: center;
    }

    .recall-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--campayo-success);
        margin-bottom: 2rem;
    }

    .recall-input {
        background: white;
        
        border-radius: 8px;
        padding: 1rem;
        font-size: 1.25rem;
        text-align: center;
        margin-bottom: 1rem;
        min-width: 250px;
        transition: border-color 0.3s ease;
    }

    .recall-input:focus {
        border-color: var(--campayo-primary);
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .recall-input.correct {
        border-color: var(--campayo-success);
        background-color: rgba(25, 135, 84, 0.1);
    }

    .recall-input.incorrect {
        border-color: var(--campayo-danger);
        background-color: rgba(220, 53, 69, 0.1);
    }

    /* Categorías específicas */
    .category-fruits .evm-item {
        border-left-color: #fd7e14;
        color: #fd7e14;
    }

    .category-months .evm-item {
        border-left-color: #6f42c1;
        color: #6f42c1;
    }

    .category-countries .evm-item {
        border-left-color: #20c997;
        color: #20c997;
    }

    .category-names .evm-item {
        border-left-color: #e91e63;
        color: #e91e63;
    }

    /* Controles específicos */
    .evm-controls {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .evm-stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-bottom: 1rem;
    }

    .evm-stat {
        flex: 1;
    }

    .evm-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--campayo-primary);
    }

    .evm-stat-label {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* Fase indicators */
    .phase-indicator {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .phase-memorization {
        color: var(--campayo-primary);
        border: 2px solid var(--campayo-primary);
    }

    .phase-recall {
        color: var(--campayo-success);
        border: 2px solid var(--campayo-success);
    }

    /* Resultados */
    .results-display {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .accuracy-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .evm-item {
            font-size: 1.25rem;
            padding: 0.75rem 1.5rem;
            min-width: 180px;
        }
        
        .countdown-display {
            font-size: 3rem;
        }
        
        .recall-input {
            font-size: 1.1rem;
            min-width: 200px;
        }
        
        .accuracy-circle {
            width: 100px;
            height: 100px;
            font-size: 1.25rem;
        }
    }

    @media (max-width: 576px) {
        .evm-content {
            padding: 1rem;
        }
        
        .evm-item {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
            min-width: 150px;
        }
        
        .countdown-display {
            font-size: 2.5rem;
        }
        
        .recall-input {
            font-size: 1rem;
            min-width: 180px;
        }
        
        .evm-stats {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Header del Ejercicio -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="h4 fw-bold mb-1">
                            <i class="bi bi-stopwatch me-2"></i>{{ ejercicio.codigo }} - Velocidad de Memorización
                        </h1>
                        <p class="text-muted small mb-0">{{ ejercicio.descripcion }}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">Nivel {{ ejercicio.nivel }}</span>
                        {% if ejercicio.requiere_pro %}
                        <span class="badge bg-warning text-dark">Pro</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-info">{{ ejercicio.categoria.nombre }}</span>
                    <a href="{% url 'ejercicios:lista' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="card mb-4" id="instructions-card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i> Instrucciones del Ejercicio
                </h6>
            </div>
            <div class="card-body">
                <div id="evm-instructions">
                    <h6>Entrenamiento de Velocidad de Memorización</h6>
                    <p>Este ejercicio mejora tu capacidad de memorizar listas de elementos en poco tiempo.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="small fw-bold">Fase 1: Memorización</h6>
                            <ul class="small">
                                <li>Observa atentamente la lista que aparece</li>
                                <li>Trata de memorizar todos los elementos</li>
                                <li>Usa técnicas de asociación mental</li>
                                <li>Aprovecha todo el tiempo disponible</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="small fw-bold">Fase 2: Recuerdo</h6>
                            <ul class="small">
                                <li>Escribe todos los elementos que recuerdes</li>
                                <li>El orden no importa</li>
                                <li>Presiona Enter después de cada elemento</li>
                                <li>Haz clic en "Finalizar" cuando termines</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Configuración -->
                <div class="mt-3" id="evm-config">
                    <h6 class="small fw-bold">Configuración:</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">Categoría</label>
                            <select class="form-select" id="category-select">
                                <option value="fruits">Frutas</option>
                                <option value="months">Meses</option>
                                <option value="countries">Países</option>
                                <option value="names">Nombres</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Elementos a memorizar</label>
                            <input type="range" class="form-range" id="items-slider" 
                                   min="3" max="12" value="{{ cantidad_items|default:5 }}" step="1">
                            <div class="small text-muted text-center">
                                <span id="items-value">{{ cantidad_items|default:5 }}</span> elementos
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Tiempo de memorización</label>
                            <input type="range" class="form-range" id="time-slider" 
                                   min="5" max="30" value="{{ tiempo_display|default:10 }}" step="5">
                            <div class="small text-muted text-center">
                                <span id="time-value">{{ tiempo_display|default:10 }}</span> segundos
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button id="start-evm-exercise" class="btn btn-primary btn-lg">
                        <i class="bi bi-play"></i> Comenzar Entrenamiento
                    </button>
                </div>
            </div>
        </div>

        <!-- Área de Display del Ejercicio -->
        <div class="evm-display-area" id="evm-display-area" style="display: none;">
            <div class="phase-indicator" id="phase-indicator">Fase 1: Memorización</div>
            <div class="evm-content" id="evm-content">
                <!-- El contenido se generará dinámicamente -->
            </div>
        </div>

        <!-- Controles -->
        <div class="evm-controls" id="evm-controls" style="display: none;">
            <div class="evm-stats">
                <div class="evm-stat">
                    <div class="evm-stat-value" id="phase-display">Memorización</div>
                    <div class="evm-stat-label">Fase actual</div>
                </div>
                <div class="evm-stat">
                    <div class="evm-stat-value" id="items-count">0</div>
                    <div class="evm-stat-label">Elementos</div>
                </div>
                <div class="evm-stat">
                    <div class="evm-stat-value" id="evm-timer">00:00</div>
                    <div class="evm-stat-label">Tiempo</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button id="complete-evm" class="btn btn-success" style="display: none;">
                            <i class="bi bi-check"></i> Finalizar Recuerdo
                        </button>
                        <button id="stop-evm" class="btn btn-danger">
                            <i class="bi bi-stop"></i> Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuración simplificada
const EVM = {
    ejercicioId: {{ ejercicio.id }},
    categoria: 'fruits',
    cantidadItems: 5,
    tiempoMemorizacion: 10,
    
    // Estado
    fase: 'memorization', // 'memorization', 'recall', 'results'
    iniciado: false,
    tiempoInicio: null,
    items: [],
    recordados: []
};

// Datos por categoría
const contenidos = {
    fruits: ['manzana', 'naranja', 'plátano', 'uva', 'fresa', 'kiwi', 'mango', 'pera'],
    months: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto'],
    countries: ['España', 'Francia', 'Italia', 'Portugal', 'Alemania', 'Holanda', 'Bélgica', 'Suiza'],
    names: ['Carlos', 'María', 'José', 'Ana', 'Luis', 'Carmen', 'Miguel', 'Elena']
};

// Elementos DOM
const $ = id => document.getElementById(id);
const instrucciones = $('instructions-card');
const pantallaEjercicio = $('evm-display-area');
const contenido = $('evm-content');
const indicadorFase = $('phase-indicator');
const controles = $('evm-controls');
const timer = $('evm-timer');

// Generar items aleatorios
const generarItems = () => {
    const disponibles = contenidos[EVM.categoria];
    const mezclados = [...disponibles].sort(() => 0.5 - Math.random());
    EVM.items = mezclados.slice(0, EVM.cantidadItems);
};

// Fase de memorización
const faseMemorizacion = () => {
    EVM.fase = 'memorization';
    indicadorFase.textContent = 'Fase 1: Memorización';
    indicadorFase.className = 'phase-indicator phase-memorization';
    $('phase-display').textContent = 'Memorización';
    
    const itemsHTML = EVM.items.map(item => 
        `<div class="evm-item">${item}</div>`
    ).join('');
    
    contenido.innerHTML = `
        <div class="memorization-phase category-${EVM.categoria}">
            <div class="memorization-title">Memoriza estos elementos:</div>
            <div class="evm-list">${itemsHTML}</div>
            <div class="countdown-display" id="countdown">${EVM.tiempoMemorizacion}</div>
        </div>`;
    
    iniciarCountdown();
};

// Countdown de memorización
const iniciarCountdown = () => {
    let tiempo = EVM.tiempoMemorizacion;
    const countdown = $('countdown');
    
    const intervalo = setInterval(() => {
        tiempo--;
        countdown.textContent = tiempo;
        
        if (tiempo <= 0) {
            clearInterval(intervalo);
            faseRecuerdo();
        }
    }, 1000);
};

// Fase de recuerdo
const faseRecuerdo = () => {
    EVM.fase = 'recall';
    indicadorFase.textContent = 'Fase 2: Recuerdo';
    indicadorFase.className = 'phase-indicator phase-recall';
    $('phase-display').textContent = 'Recuerdo';
    $('complete-evm').style.display = 'inline-block';
    
    contenido.innerHTML = `
        <div class="recall-phase">
            <div class="recall-title">Escribe todos los elementos que recuerdes:</div>
            <div id="inputs-container">
                <input type="text" class="recall-input" id="input-0" placeholder="Elemento..." autocomplete="off">
            </div>
            <div class="mt-3">
                <small class="text-muted">Presiona Enter para añadir otro</small>
            </div>
        </div>`;
    
    configurarInput(0);
};

// Configurar input con auto-navegación
const configurarInput = (indice) => {
    const input = $(`input-${indice}`);
    if (!input) return;
    
    input.focus();
    input.onkeydown = (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            const valor = input.value.trim().toLowerCase();
            EVM.recordados.push(valor);
            
            // Marcar como correcto/incorrecto
            const correcto = EVM.items.some(item => item.toLowerCase() === valor);
            input.className = `recall-input ${correcto ? 'correct' : 'incorrect'}`;
            input.disabled = true;
            
            // Crear siguiente input
            const siguienteIndice = indice + 1;
            const container = $('inputs-container');
            container.innerHTML += `
                <input type="text" class="recall-input" id="input-${siguienteIndice}" 
                       placeholder="Elemento..." autocomplete="off">`;
            
            configurarInput(siguienteIndice);
        }
    };
};

// Calcular resultados
const calcularResultados = () => {
    const correctos = EVM.recordados.filter(recordado => 
        EVM.items.some(original => original.toLowerCase() === recordado.toLowerCase())
    );
    
    return {
        correctos: correctos.length,
        total: EVM.items.length,
        recordados: EVM.recordados.length,
        precision: Math.round((correctos.length / EVM.items.length) * 100)
    };
};

// Actualizar timer
const actualizarTimer = () => {
    if (!EVM.tiempoInicio) return;
    
    const transcurrido = Date.now() - EVM.tiempoInicio;
    const minutos = Math.floor(transcurrido / 60000);
    const segundos = Math.floor((transcurrido % 60000) / 1000);
    timer.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
};

// Iniciar ejercicio
const iniciar = () => {
    if (EVM.iniciado) return;
    
    EVM.tiempoInicio = Date.now();
    EVM.iniciado = true;
    EVM.recordados = [];
    
    generarItems();
    
    // UI
    instrucciones.style.display = 'none';
    pantallaEjercicio.style.display = 'block';
    controles.style.display = 'block';
    
    $('items-count').textContent = EVM.cantidadItems;
    setInterval(actualizarTimer, 100);
    faseMemorizacion();
};

// Completar ejercicio
const completar = () => {
    const tiempo = Date.now() - EVM.tiempoInicio;
    const resultados = calcularResultados();
    
    // Marcar como completado
    fetch('{% url "ejercicios:completar" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `ejercicio_id=${EVM.ejercicioId}&tiempo_ms=${tiempo}`
    });
    
    // Mostrar resultados
    const minutos = Math.floor(tiempo / 60000);
    const segundos = Math.floor((tiempo % 60000) / 1000);
    const colorPrecision = resultados.precision >= 80 ? 'success' : 
                          resultados.precision >= 60 ? 'warning' : 'danger';
    
    contenido.innerHTML = `
        <div class="text-center">
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <h3 class="mt-3 text-success">¡Ejercicio Completado!</h3>
            
            <div class="results-display mt-4">
                <div class="accuracy-circle bg-${colorPrecision}">${resultados.precision}%</div>
                <div class="row text-center">
                    <div class="col-3">
                        <div class="h5 text-success">${resultados.correctos}</div>
                        <div class="small text-muted">Correctos</div>
                    </div>
                    <div class="col-3">
                        <div class="h5 text-primary">${resultados.total}</div>
                        <div class="small text-muted">Total</div>
                    </div>
                    <div class="col-3">
                        <div class="h5 text-info">${resultados.recordados}</div>
                        <div class="small text-muted">Recordados</div>
                    </div>
                    <div class="col-3">
                        <div class="h5 text-secondary">${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}</div>
                        <div class="small text-muted">Tiempo</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <a href="{% url 'ejercicios:lista' %}" class="btn btn-primary me-2">Ver Ejercicios</a>
                <button onclick="location.reload()" class="btn btn-outline-primary">Repetir</button>
            </div>
        </div>`;
    
    indicadorFase.style.display = 'none';
    controles.style.display = 'none';
};

// Salir
const salir = () => {
    if (confirm('¿Salir del ejercicio?')) {
        location.href = '{% url "ejercicios:lista" %}';
    }
};

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    $('start-evm-exercise').onclick = iniciar;
    $('complete-evm').onclick = completar;
    $('stop-evm').onclick = salir;
    
    // Configuración
    $('category-select').onchange = (e) => {
        EVM.categoria = e.target.value;
    };
    
    $('items-slider').oninput = (e) => {
        EVM.cantidadItems = parseInt(e.target.value);
        $('items-value').textContent = EVM.cantidadItems;
    };
    
    $('time-slider').oninput = (e) => {
        EVM.tiempoMemorizacion = parseInt(e.target.value);
        $('time-value').textContent = EVM.tiempoMemorizacion;
    };
});
</script>
{% endblock %}